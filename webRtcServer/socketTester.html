<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <canvas id="canvas" width="640" height="480"></canvas>

    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <script>
        const { RTCPeerConnection } = window;
        class User {
            constructor(id) {
                this.id = id;
                this.pc = null;
            }
        }

        function createPeer(user, socket) {
            const rtcConfiguration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' }
                ]
            }

            const pc = new RTCPeerConnection(rtcConfiguration);
            pc.ondatachannel = (event) => {
                event.channel.onmessage = (event) => {
                    const base64Frame = event.data;
                    const image = new Image();
                    image.onload = function() {
                        // Limpa o canvas e desenha a imagem
                        context.clearRect(0, 0, canvas.width, canvas.height);
                        context.drawImage(image, 0, 0, canvas.width, canvas.height);
                    };
                    image.src = 'data:image/jpeg;base64,' + arrayBufferToBase64(event.data); 
                };
            };

            pc.onicecandidate = (event) => {
                if (!event.candidate) {
                    return;
                }
                socket.emit('candidate', {
                    id: socket.id,
                    candidate: event.candidate,
                    type: 'listener',
                });
            };

            return pc;
        }

        function arrayBufferToBase64(buffer) {
            var binary = '';
            var bytes = new Uint8Array(buffer);
            var len = bytes.byteLength;
            for (var i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        const users = new Map();
        const socket = io('http://localhost:6060', {
            query: {
                dados: JSON.stringify({
                    type: "listener",
                    channel: "camera1", 
                })
            }
        });

        socket.on('connect', () => {
            console.log('Conectado ao servidor');
        });

        socket.on('disconnect', () => {
            console.log('Desconectado do servidor');
            socket.disconnect();
        });

        socket.on('candidate', function (data) {
            if (data.type === 'streamer') {
                let user = users.get(data.id);
                if (!user) {
                    user = new User(data.id);
                    user.pc = createPeer(user, socket);
                    users.set(data.id, user);
                }
                user.pc.addIceCandidate(data.candidate).then(() => {
                    console.log('Candidato adicionado com sucesso');
                }).catch((error) => {
                    console.error('Erro ao adicionar candidato:', error);
                });
            }
        });
        
        socket.on('offer', function (data) {
            let user = users.get(data.id);
            if (!user) {
                user = new User(data.id);
                user.pc = createPeer(user, socket);
                users.set(data.id, user);
            }
            user.pc.setRemoteDescription(data.offer).then(() => {
                user.pc.createAnswer().then((answer) => {
                    return user.pc.setLocalDescription(answer);
                }).then(() => {
                    socket.emit('answer', {
                        id: user.id,
                        answer: user.pc.localDescription
                    });
                }).catch((error) => {
                    console.error('Erro ao criar e enviar resposta:', error);
                });
            }).catch((error) => {
                console.error('Erro ao configurar descrição remota:', error);
            });
        });
         
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
    
         
    </script>
</body>
</html>
